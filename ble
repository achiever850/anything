WITH CTE_RETIRE AS (
    SELECT 
        f.factpsgvtjobid AS retirementeligibilitysid,
        CASE 
            WHEN f.gvt_retire_plan = '1' THEN 'FULL CSRS'
            WHEN f.gvt_retire_plan = '2' THEN 'FICA'
            WHEN f.gvt_retire_plan = '4' THEN 'NONE'
            WHEN f.gvt_retire_plan = '5' THEN 'NAF'
            WHEN f.gvt_retire_plan = '6' THEN 'CSRS-SPEC'
            WHEN f.gvt_retire_plan = 'C' THEN 'CSRS-OFFSET'
            WHEN f.gvt_retire_plan = 'E' THEN 'CSRS-OFFSET-SPEC'
            WHEN f.gvt_retire_plan = 'K' THEN 'FERS'
            WHEN f.gvt_retire_plan = 'KR' THEN 'FERS-RAE'
            WHEN f.gvt_retire_plan = 'KF' THEN 'FERS-FRAE'
            WHEN f.gvt_retire_plan = 'MF' THEN 'FERS-SPEC'
            WHEN f.gvt_retire_plan = 'R' THEN 'FICA AND FULL CSRS'
            WHEN f.gvt_retire_plan = 'T' THEN 'FICA AND FULL CSRS SPEC'
            ELSE 'UNKNOWN' 
        END AS category,
        gp.birthdate,
        -- Add additional eligibility logic here
        CASE 
            WHEN f.gvt_retire_plan IN ('K', 'KF', 'KR', 'M', 'MF', 'MR') THEN 
                CASE 
                    WHEN DATEADD(YEAR, 30, gp.birthdate) < GETDATE() THEN 'Eligible for MRA 30'
                    ELSE 'Not Eligible for MRA 30'
                END
            ELSE 'Not Applicable'
        END AS Eligibility_MRA_30
    FROM 
        DATAWAREHOUSE.HRSMART_FACTPSGVTJOB f
    LEFT JOIN DATAWAREHOUSE.HRSMART_DIMPSGVTEMPLOYMENT e ON f.DIMPSGVTEMPLOYMENTID = e.DIMPSGVTEMPLOYMENTID
    LEFT JOIN DATAWAREHOUSE.HRSMART_DIMPSGVTPERSDATA gp ON f.DIMPSGVTPERSDATAID = gp.DIMPSGVTPERSDATAID
),

CTE_DETAIL AS (
    SELECT
        GJ.EMPLID,
        GJ.EMPL_RCD,
        GJ.EFFDT,
        R.CATEGORY,
        R.Eligibility_MRA_30,
        R.BIRTHDATE,
        CASE 
            WHEN FIRST_ELIGIBILITY_DATE IS NULL THEN NULL 
            WHEN FIRST_ELIGIBILITY_DATE <= DATE '2024-08-08' THEN 'YES' 
            ELSE 'NO' 
        END AS RETIREMENT_ELIGIBLE_FLAG,
        ((DATEDIFF(YEAR, R.BIRTHDATE, DATE'2024-08-08') - 
        CASE WHEN DATE '2024-08-08' < DATEDIFF(YEAR, R.BIRTHDATE, DATE'2024-08-08') THEN 1 ELSE 0 END)) AS AGE,
        CASE
            WHEN (AGE >= 65) THEN '65+'
            WHEN (AGE >= 55 AND AGE < 65) THEN '55-64'
            WHEN (AGE >= 45 AND AGE < 55) THEN '45-54'
            WHEN (AGE >= 35 AND AGE < 45) THEN '35-44'
            WHEN (AGE >= 30 AND AGE < 35) THEN '30-34'
            WHEN (AGE >= 25 AND AGE < 30) THEN '25-29'
            ELSE '24 AND UNDER' 
        END AS AGE_GROUP
    FROM 
        DATAWAREHOUSE.HRSMART_FACTPSGVTJOB GJ
    LEFT JOIN DATAWAREHOUSE.HRSMART_DIMPSGVTPAYPLAN PP ON GJ.DIMPSGVTPAYPLANID = PP.DIMPSGVTPAYPLANID
    LEFT JOIN CTE_RETIRE R ON GJ.FACTPSGVTJOBID = R.RETIREMENTELIGIBILITYSID
    WHERE 
        '2024-06-05' BETWEEN GJ.EFFDT AND GJ.EXPDT 
        AND PP.GVT_PAY_PLAN != '00'
        AND GJ.EMPL_STATUS IN('A', 'L', 'S', 'P', 'W')
        AND GJ.GVT_STATUS_TYPE IN('COM', 'COR')
)

SELECT 
    CATEGORY, 
    AGE_GROUP, 
    EMPLID 
FROM (
    SELECT CATEGORY, AGE_GROUP, EMPLID
    FROM CTE_DETAIL
    WHERE RETIREMENT_ELIGIBLE_FLAG = 'YES'
    
    UNION ALL

    SELECT CATEGORY, AGE_GROUP, EMPLID
    FROM CTE_DETAIL
    WHERE RETIREMENT_ELIGIBLE_FLAG IS NULL
    
    UNION ALL

    SELECT 'NON-ELIGIBLE' AS CATEGORY, AGE_GROUP, EMPLID
    FROM CTE_DETAIL
    WHERE RETIREMENT_ELIGIBLE_FLAG ='NO'
    
    UNION ALL

    SELECT 'TOTAL ACTIVE EMPLOYEE' AS CATEGORY, AGE_GROUP, EMPLID
    FROM CTE_DETAIL
) AS UNION_ALL_RESULT
ORDER BY CATEGORY, AGE_GROUP, EMPLID;
