WITH CTE_RETIRE AS (
    SELECT 
        f.factpsgvtjobid AS retirementeligibilitysid,
        CASE 
            WHEN f.gvt_retire_plan = '1' THEN 'FULL CSRS'
            WHEN f.gvt_retire_plan = '2' THEN 'FICA'
            WHEN f.gvt_retire_plan = '4' THEN 'NONE'
            WHEN f.gvt_retire_plan = '5' THEN 'NAF'
            WHEN f.gvt_retire_plan = '6' THEN 'CSRS-SPEC'
            WHEN f.gvt_retire_plan = 'C' THEN 'CSRS-OFFSET'
            WHEN f.gvt_retire_plan = 'E' THEN 'CSRS-OFFSET-SPEC'
            WHEN f.gvt_retire_plan = 'K' THEN 'FERS'
            WHEN f.gvt_retire_plan = 'KR' THEN 'FERS-RAE'
            WHEN f.gvt_retire_plan = 'KF' THEN 'FERS-FRAE'
            WHEN f.gvt_retire_plan = 'MF' THEN 'FERS-SPEC'
            WHEN f.gvt_retire_plan = 'R' THEN 'FICA AND FULL CSRS'
            WHEN f.gvt_retire_plan = 'T' THEN 'FICA AND FULL CSRS SPEC'
            ELSE 'UNKNOWN' 
        END AS category,
        gp.birthdate,
        E.GVT_SCD_RETIRE,

        -- Eligibility calculations based on age and years of service
        CASE 
            WHEN DATE_PART(YEAR, CURRENT_DATE) - DATE_PART(YEAR, gp.birthdate) >= 62 AND 
                 E.GVT_SCD_RETIRE <= CURRENT_DATE THEN CURRENT_DATE
            WHEN DATE_PART(YEAR, CURRENT_DATE) - DATE_PART(YEAR, gp.birthdate) >= 55 AND 
                 E.GVT_SCD_RETIRE <= CURRENT_DATE THEN CURRENT_DATE
            WHEN DATE_PART(YEAR, CURRENT_DATE) - DATE_PART(YEAR, gp.birthdate) >= 50 AND 
                 E.GVT_SCD_RETIRE <= CURRENT_DATE AND f.gvt_retire_plan IN ('M', 'MR', 'MF', '6', 'E', 'T') THEN CURRENT_DATE
            ELSE NULL
        END AS first_eligibility_date
    FROM 
        DATAWAREHOUSE.HRSMART_FACTPSGVTJOB F
    LEFT JOIN 
        DATAWAREHOUSE.HRSMART_DIMPSGVTEMPLOYMENT E ON F.DIMPSGVTPAYPLANID = E.DIMPSGVTPAYPLANID
    LEFT JOIN 
        DATAWAREHOUSE.HRSMART_DIMPSGVTPERSDATA GP ON F.DIMPSGVTPERSDATAID = GP.DIMPSGVTPERSDATAID
),

CTE_DETAIL AS (
    SELECT
        GJ.EMPLID,
        R.CATEGORY,
        DATE_PART(YEAR, CURRENT_DATE) - DATE_PART(YEAR, gp.birthdate) AS age,
        CASE 
            WHEN age >= 65 THEN '65+'
            WHEN age >= 55 AND age < 65 THEN '55-64'
            WHEN age >= 45 AND age < 55 THEN '45-54'
            WHEN age >= 35 AND age < 45 THEN '35-44'
            WHEN age >= 30 AND age < 35 THEN '30-34'
            WHEN age >= 25 AND age < 30 THEN '25-29'
            ELSE '24 AND UNDER' 
        END AS age_group,
        CASE 
            WHEN R.first_eligibility_date IS NULL THEN NULL 
            WHEN R.first_eligibility_date <= CURRENT_DATE THEN 'YES' 
            ELSE 'NO' 
        END AS retirement_eligible_flag
    FROM 
        DATAWAREHOUSE.HRSMART_FACTPSGVTJOB GJ
    LEFT JOIN 
        DATAWAREHOUSE.HRSMART_DIMPSGVTPAYPLAN PP ON GJ.DIMPSGVTPAYPLANID = PP.DIMPSGVTPAYPLANID
    LEFT JOIN 
        CTE_RETIRE R ON GJ.FACTPSGVTJOBID = R.retirementeligibilitysid
    LEFT JOIN 
        DATAWAREHOUSE.HRSMART_DIMPSGVTPERSDATA GP ON GJ.DIMPSGVTPERSDATAID = GP.DIMPSGVTPERSDATAID
    WHERE 
        '2024-06-05' BETWEEN GJ.EFFDT AND GJ.EXPDT 
        AND PP.GVT_PAY_PLAN != '00'
        AND GJ.EMPL_STATUS IN ('A', 'L', 'S', 'P', 'W')
        AND GJ.GVT_STATUS_TYPE IN ('COM', 'COR')
),

CTE_AGGREGATED AS (
    SELECT 
        CATEGORY,
        AGE_GROUP,
        COUNT(DISTINCT EMPLID) AS employee_count,
        LISTAGG(EMPLID, ', ') WITHIN GROUP (ORDER BY EMPLID) AS employee_ids
    FROM 
        CTE_DETAIL
    WHERE 
        retirement_eligible_flag = 'YES'
    GROUP BY 
        CATEGORY, AGE_GROUP

    UNION ALL

    SELECT 
        CATEGORY,
        AGE_GROUP,
        COUNT(DISTINCT EMPLID) AS employee_count,
        LISTAGG(EMPLID, ', ') WITHIN GROUP (ORDER BY EMPLID) AS employee_ids
    FROM 
        CTE_DETAIL
    WHERE 
        retirement_eligible_flag IS NULL
    GROUP BY 
        CATEGORY, AGE_GROUP

    UNION ALL

    SELECT 
        'NON-ELIGIBLE' AS CATEGORY,
        AGE_GROUP,
        COUNT(DISTINCT EMPLID) AS employee_count,
        LISTAGG(EMPLID, ', ') WITHIN GROUP (ORDER BY EMPLID) AS employee_ids
    FROM 
        CTE_DETAIL
    WHERE 
        retirement_eligible_flag = 'NO'
    GROUP BY 
        AGE_GROUP

    UNION ALL

    SELECT 
        'TOTAL ACTIVE EMPLOYEE' AS CATEGORY,
        AGE_GROUP,
        COUNT(DISTINCT EMPLID) AS employee_count,
        LISTAGG(EMPLID, ', ') WITHIN GROUP (ORDER BY EMPLID) AS employee_ids
    FROM 
        CTE_DETAIL
    GROUP BY 
        AGE_GROUP
)

SELECT * FROM CTE_AGGREGATED
ORDER BY CATEGORY, AGE_GROUP;
