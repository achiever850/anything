WITH CTE_RETIRE AS (
    SELECT 
        f.factpsgvtjobid AS retirementeligibilitysid,
        f.gvt_retire_plan,
        CASE f.gvt_retire_plan
            WHEN '1' THEN 'FULL CSRS'
            WHEN '2' THEN 'FICA'
            WHEN '4' THEN 'NONE'
            WHEN '5' THEN 'NAF'
            WHEN '6' THEN 'CSRS-SPEC'
            WHEN 'C' THEN 'CSRS-OFFSET'
            WHEN 'E' THEN 'CSRS-OFFSET-SPEC'
            WHEN 'K' THEN 'FERS'
            WHEN 'KR' THEN 'FERS-RAE'
            WHEN 'KF' THEN 'FERS-FRAE'
            WHEN 'MF' THEN 'FERS-SPEC'
            WHEN 'R' THEN 'FICA AND FULL CSRS'
            WHEN 'T' THEN 'FICA AND FULL CSRS SPEC'
            ELSE 'UNKNOWN' 
        END AS category,
        gp.birthdate,
        -- Additional eligibility date calculations can go here
        -- (Add the eligibility calculations as needed)
    FROM 
        DATAWAREHOUSE.HRSMART_FACTPSGVTJOB F
    LEFT JOIN 
        DATAWAREHOUSE.HRSMART_DIMPSGVTEMPLOYMENT E ON F.DIMPSGVTEMPLOYMENTID = E.DIMPSGVTEMPLOYMENTID
    LEFT JOIN 
        DATAWAREHOUSE.HRSMART_DIMPSGVTPERSDATA GP ON F.DIMPSGVTPERSDATAID = GP.DIMPSGVTPERSDATAID
),

CTE_DETAIL AS (
    SELECT
        GJ.EMPLID,
        R.CATEGORY,
        R.FIRST_ELIGIBILITY_DATE,
        CASE 
            WHEN FIRST_ELIGIBILITY_DATE IS NULL THEN NULL 
            WHEN FIRST_ELIGIBILITY_DATE <= DATE '2024-08-08' THEN 'YES' 
            ELSE 'NO' 
        END AS RETIREMENT_ELIGIBLE_FLAG,
        (DATEDIFF(YEAR, R.BIRTHDATE, DATE '2024-08-08') - 
            CASE WHEN DATE '2024-08-08' < DATEDIFF(YEAR, R.BIRTHDATE, DATE '2024-08-08') THEN 1 ELSE 0 END) AS AGE,
        CASE
            WHEN AGE >= 65 THEN '65+'
            WHEN AGE >= 55 THEN '55-64'
            WHEN AGE >= 45 THEN '45-54'
            WHEN AGE >= 35 THEN '35-44'
            WHEN AGE >= 30 THEN '30-34'
            WHEN AGE >= 25 THEN '25-29'
            ELSE '24 AND UNDER' 
        END AS AGE_GROUP
    FROM 
        DATAWAREHOUSE.HRSMART_FACTPSGVTJOB GJ
    LEFT JOIN 
        DATAWAREHOUSE.HRSMART_DIMPSGVTPAYPLAN PP ON GJ.DIMPSGVTPAYPLANID = PP.DIMPSGVTPAYPLANID
    LEFT JOIN 
        CTE_RETIRE R ON GJ.FACTPSGVTJOBID = R.RETIREMENTELIGIBILITYSID
    WHERE 
        '2024-06-05' BETWEEN GJ.EFFDT AND GJ.EXPDT 
        AND PP.GVT_PAY_PLAN != '00'
        AND GJ.EMPL_STATUS IN ('A', 'L', 'S', 'P', 'W')
        AND GJ.GVT_STATUS_TYPE IN ('COM', 'COR')
)

SELECT 
    CATEGORY, 
    AGE_GROUP, 
    STRING_AGG(EMPLID::TEXT, ', ') AS EMPLOYEE_IDS -- Aggregate EMPLIDs as a comma-separated list
FROM 
    CTE_DETAIL
WHERE 
    RETIREMENT_ELIGIBLE_FLAG = 'YES'
GROUP BY 
    CATEGORY, AGE_GROUP

UNION ALL

SELECT 
    CATEGORY, 
    AGE_GROUP, 
    STRING_AGG(EMPLID::TEXT, ', ') AS EMPLOYEE_IDS 
FROM 
    CTE_DETAIL
WHERE  
    RETIREMENT_ELIGIBLE_FLAG IS NULL
GROUP BY 
    CATEGORY, AGE_GROUP

UNION ALL

SELECT 
    'NON-ELIGIBLE' AS CATEGORY,
    AGE_GROUP, 
    STRING_AGG(EMPLID::TEXT, ', ') AS EMPLOYEE_IDS 
FROM 
    CTE_DETAIL
WHERE 
    RETIREMENT_ELIGIBLE_FLAG = 'NO'
GROUP BY 
    AGE_GROUP

UNION ALL

SELECT 
    'TOTAL ACTIVE EMPLOYEE' AS CATEGORY,
    AGE_GROUP,
    STRING_AGG(EMPLID::TEXT, ', ') AS EMPLOYEE_IDS 
FROM 
    CTE_DETAIL
GROUP BY 
    AGE_GROUP

ORDER BY 
    CATEGORY, AGE_GROUP;
